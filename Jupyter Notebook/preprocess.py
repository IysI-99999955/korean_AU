# preprocess.py (전체 사전 포함)  5차 수정..
import os

os.environ["XLA_FLAGS"] = "--xla_gpu_cuda_data_dir=/usr/local/cuda"

import pandas as pd
import os
import re
from tqdm import tqdm
from pykospacing import Spacing

# pandas의 progress_apply를 사용하기 위한 설정
tqdm.pandas()

# 대규모 한국어 신조어, 혐오, 욕설 및 오타 전체 사전
slang_dic = {
    # =============================================
    # 1. 초성/단순 축약어
    # =============================================
    "ㅋㅋ": "웃음",
    "ㅋㅋㅋ": "웃음",
    "ㅋㅋㅋㅋ": "웃음",
    "ㅋㄷㅋㄷ": "웃음",
    "풉": "웃음",
    "ㅎㅎ": "웃음",
    "ㅎㅎㅎ": "웃음",
    "ㅎㄷㄷ": "놀람",
    "ㄷㄷ": "놀람",
    "헉": "놀람",
    "ㅠㅠ": "슬픔",
    "ㅜㅜ": "슬픔",
    "ㅜㅠ": "슬픔",
    "ㅠㅜ": "슬픔",
    "롬곡": "눈물",
    "ㅇㅇ": "응",
    "ㅇㅋ": "오케이",
    "오키": "오케이",
    "ㄴㄴ": "아니요",
    "ㄱㅅ": "감사",
    "ㄳ": "감사",
    "감사합니당": "감사합니다",
    "고맙": "고맙습니다",
    "ㅈㅅ": "죄송",
    "죄송해여": "죄송해요",
    "뎨동": "죄송",
    "ㅅㄱ": "수고",
    "수고여": "수고하세요",
    "ㄱㄱ": "고고",
    "ㄱㄱㅆ": "고고씽",
    "가즈아": "가자",
    "ㅇㅈ": "인정",
    "ㅆㅇㅈ": "매우 인정",
    "쌉인정": "매우 인정",
    "ㅇㄱㄹㅇ": "이거 레알",
    "ㅊㅋ": "축하",
    "ㅊㅊ": "추천",
    "ㅂㅂ": "안녕",
    "ㅃㅃ": "안녕",
    "ㅂㅇ": "안녕",
    "빠이": "안녕",
    "뭐임": "뭐임",
    "머임": "뭐임",
    "ㅁㅇ": "뭐임",
    "왤케": "왜 이렇게",
    "욀케": "왜 이렇게",
    # =============================================
    # 2. 최신 인터넷/커뮤니티 용어
    # =============================================
    "JMT": "매우 맛있다",
    "jmt": "매우 맛있다",
    "존맛": "매우 맛있다",
    "존맛탱": "매우 맛있다",
    "개꿀": "매우 좋다",
    "꿀잼": "매우 재미있다",
    "노잼": "재미없다",
    "핵노잼": "매우 재미없다",
    "쌉가능": "완전 가능",
    "쌉소리": "헛소리",
    "레게노": "레전드",
    "레알": "정말",
    "ㄹㅇ": "정말",
    "진심": "정말",
    "찐": "진짜",
    "갑분싸": "갑자기 분위기 싸해진다",
    "갑분띠": "갑자기 분위기 띠용",
    "TMI": "과한 정보",
    "tmi": "과한 정보",
    "별다줄": "별걸 다 줄인다",
    "아무말": "아무말 대잔치",
    "사바사": "사람 따라 다르다",
    "케바케": "경우 따라 다르다",
    "내로남불": "위선",
    "오저치고": "오늘 저녁 치킨 먹자",
    "혼코노": "혼자 코인 노래방",
    "얼죽아": "얼어 죽어도 아이스 아메리카노",
    "킹받네": "열 받네",
    "킹정": "매우 인정",
    "갓생": "모범적인 삶",
    "뇌절": "반복",
    "뇌절하다": "반복하다",
    "억까": "억지로 비판",
    "억빠": "억지로 칭찬",
    "어쩔티비": "어쩌라고",
    "저쩔티비": "어쩌라고",
    "꾸안꾸": "꾸민 듯 안 꾸민",
    "스불재": "스스로 불러온 재앙",
    "점메추": "점심 메뉴 추천",
    "저메추": "저녁 메뉴 추천",
    "많관부": "많은 관심 부탁드립니다",
    "알잘딱깔센": "알아서 잘 딱 깔끔하고 센스있게",
    "ㅈㄱㄴ": "제목이 곧 내용",
    # =============================================
    # 3. 혐오/정치/젠더/욕설 관련 용어
    # =============================================
    "한남": "한국 남자",
    "한남충": "한국 남자",
    "한녀": "한국 여자",
    "김치녀": "한국 여자",
    "맘충": "아이 엄마 비하",
    "급식충": "학생 비하",
    "틀딱": "노인 비하",
    "틀딱충": "노인 비하",
    "잼민이": "초등학생",
    "문재앙": "문재인 대통령 비하",
    "달창": "문재인 대통령 지지자 비하",
    "대깨문": "문재인 대통령 지지자",
    "일베": "일간베스트",
    "일베충": "일간베스트 사용자 비하",
    "메갈": "메갈리아",
    "워마드": "워마드",
    "꼴페미": "페미니스트 비하",
    "페미": "페미니스트",
    "좌빨": "좌파 비하",
    "수꼴": "보수 비하",
    "꼴통": "보수 비하",
    "좌좀": "좌파 비하",
    "우좀": "우파 비하",
    "짱깨": "중국인 비하",
    "쪽바리": "일본인 비하",
    "새끼": "녀석",
    "새키": "녀석",
    "ㅅㄲ": "녀석",
    "년": "여자",
    "놈": "남자",
    "지랄": "헛소리",
    "ㅈㄹ": "헛소리",
    "염병": "헛소리",
    "병신": "바보",
    "ㅂㅅ": "바보",
    "븅신": "바보",
    "또라이": "이상한 사람",
    "미친": "비정상적인",
    "꺼져": "나가",
    "닥쳐": "조용히 해",
    "시발": "욕설",
    "씨발": "욕설",
    "ㅅㅂ": "욕설",
    "ㅆㅂ": "욕설",
    "슈발": "욕설",
    "썅": "욕설",
    "대가리": "머리",
    "아갈": "입",
    "아가리": "입",
    "뒤지다": "죽다",
    "뒈지다": "죽다",
    "빻다": "못생기다",
    "와꾸": "얼굴",
    "씹": "매우",
    "꼰대": "꼰대",
    "찐따": "소심한 사람",
    "아싸": "아웃사이더",
    "호구": "어수룩한 사람",
    "흑우": "어수룩한 사람",
    "충": "벌레",
    "~충": " 비하",
    "~견": " 지지자 비하",
    "까다": "비판하다",
    "저격하다": "비판하다",
    "빠": "팬",
    "까": "안티팬",
    "선비": "선비",
    "진지충": "지나치게 진지한 사람",
    "ㅗㅗ": "모욕",
    "ㅗㅜㅑ": "놀람",
    # =============================================
    # 4. 자주 발생하는 오타 및 변형
    # =============================================
    "않이": "아니",
    "않되": "안돼",
    "안되": "안돼",
    "됌": "됨",
    "되요": "돼요",
    "됬다": "됐다",
    "됬어": "됐어",
    "어떻해": "어떡해",
    "어떡계": "어떡해",
    "어떠케": "어떻게",
    "어떡함": "어떻게 함",
    "~했음": "했습니다",
    "~했슴": "했습니다",
    "~함": "합니다",
    "~댐": "됩니다",
    "~겟": "겠",
    "할께": "할게",
    "할게요": "할게요",
    "할꺼": "할 거",
    "이렇개": "이렇게",
    "그렇개": "그렇게",
    "저렇개": "저렇게",
    "왠": "웬",
    "왠만하면": "웬만하면",
    "왠일": "웬일",
    "낳다": "낫다",
    "뵈요": "봬요",
    "뵐께요": "뵐게요",
    "어의없다": "어이없다",
    "어의가 없네": "어이가 없네",
    "문안하다": "무난하다",
    "오랫만": "오랜만",
    "오랜만에": "오랜만에",
    "설겆이": "설거지",
    "있자나": "있잖아",
    "맛잇": "맛있",
    "재밋": "재밌",
    "잼있": "재밌",
    "아따": "아",
    "머선129": "무슨 일이고",
    "댕댕이": "강아지",
    "멍뭉이": "강아지",
    "커엽다": "귀엽다",
    "넘모": "너무",
    "너무행": "너무해",
    "글구": "그리고",
    "그래두": "그래도",
}

# 속도 향상을 위해 slang_dic의 모든 키를 하나의 정규식으로 컴파일
slang_pattern = re.compile(
    "|".join(re.escape(key) for key in sorted(slang_dic.keys(), key=len, reverse=True))
)

# PyKoSpacing 객체 생성 (메모리에 한 번만 로드)
spacing = Spacing()


def preprocess(text):
    """
    최적화된 순서로 신조어 변환, 띄어쓰기 교정, 정규식을 적용하는 전처리 함수.
    """
    if not isinstance(text, str) or not text:
        return ""

    # 1단계: 신조어, 욕설, 오타 변환
    text = slang_pattern.sub(lambda m: slang_dic.get(m.group(0), m.group(0)), text)

    # 2단계: 단독 사용 'ㅗ' 처리 및 불필요한 특수 문자 1차 제거
    text = re.sub(r"(^|\s)[ㅗ]($|\s)", " 모욕 ", text)
    text = re.sub(r"[^ㄱ-ㅎㅏ-ㅣ가-힣a-zA-Z0-9.,!?&\s]", " ", text)

    # 3단계: PyKoSpacing을 이용한 띄어쓰기 교정
    text = spacing(text)

    # 4단계: 최종적으로 여러 개의 공백을 하나로 정리
    text = re.sub(r"\s+", " ", text).strip()

    return text


def main():
    """CSV와 TXT 파일을 모두 전처리하고 기존 파일을 덮어씁니다."""
    dataset_dir = "../NIKL_AU_2023_COMPETITION_v1.0"
    filenames = ["train.csv", "dev.csv", "test.csv", "combined.txt"]

    for filename in filenames:
        file_path = os.path.join(dataset_dir, filename)
        if not os.path.exists(file_path):
            print(f"경고: {file_path}를 찾을 수 없습니다. 건너뜁니다.")
            continue

        print(f"--- 전처리 시작 (최종 버전): {file_path} ---")

        file_extension = os.path.splitext(filename)[1].lower()

        if file_extension == ".csv":
            df = pd.read_csv(file_path)
            df["input"] = df["input"].progress_apply(preprocess)
            df.dropna(subset=["input"], inplace=True)
            df = df[df["input"].str.len() > 0]
            df.to_csv(file_path, index=False, encoding="utf-8")

        elif file_extension == ".txt":
            with open(file_path, "r", encoding="utf-8") as f:
                lines = f.readlines()

            temp_df = pd.DataFrame(lines, columns=["input"])
            processed_lines = temp_df["input"].progress_apply(preprocess)
            processed_lines = processed_lines[processed_lines.str.len() > 0]

            with open(file_path, "w", encoding="utf-8") as f:
                f.write("\n".join(processed_lines))

        else:
            print(f"경고: 지원하지 않는 파일 형식입니다: {filename}. 건너뜁니다.")
            continue

        print(f"--- 전처리 완료 및 저장: {file_path} ---")


if __name__ == "__main__":
    main()
